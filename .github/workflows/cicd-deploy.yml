name: CI/CD Pipeline for GCP VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

    - name: Deploy to GCP VM
  env:
    GCP_VM_IP: 34.58.167.132  # Replace with your actual VM IP
    GCP_VM_PASSWORD: ${{ secrets.GCP_VM_PASSWORD }}
  run: |
    sshpass -p "$GCP_VM_PASSWORD" ssh -t -o StrictHostKeyChecking=no ubuntu@$GCP_VM_IP << 'EOF'
      cd ~/test-node-app
      git pull origin main
      npm install
      pm2 restart all || pm2 start app.js --name "test-node-app"
      exit
    EOF
